<%- include("../partials/header") %>

<div class="container py-4" style="max-width: 1000px;">
  <h3 class="mb-4 fw-bold text-success">
    <i class="fas fa-user-injured me-2"></i>
    <%= patient ? "Edit Patient" : "New Patient" %>
  </h3>

  <form method="POST" action="<%= patient ? '/patients/' + patient.patient_id + '/update' : '/patients' %>">

    <!-- BASIC INFO -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-semibold">Patient Information</div>
      <div class="card-body row g-3">

        <div class="col-md-6">
          <label class="form-label">First Name</label>
          <input name="first_name" class="form-control"
                 value="<%= patient?.first_name || '' %>">
        </div>

        <div class="col-md-6">
          <label class="form-label">Last Name</label>
          <input name="last_name" class="form-control"
                 value="<%= patient?.last_name || '' %>">
        </div>

        <div class="col-md-4">
          <label class="form-label">Gender:</label>
          <select name="gender" class="form-select">
            <option value="">Select</option>
            <option <%= patient?.gender==="Male"?"selected":"" %>>Male</option>
            <option <%= patient?.gender==="Female"?"selected":"" %>>Female</option>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Phone Number:</label>
          <input name="phone" class="form-control"
                 value="<%= patient?.phone || '' %>">
        </div>

        <div class="col-md-4">
          <label class="form-label">Date of Birth (or leave if unknown)</label>
          <input type="date" name="date_of_birth" class="form-control"
                 value="<%= patient?.date_of_birth || '' %>">
        </div>
        <div class="col-md-6">
            <div class="col-md-6">
                <label class="form-label">Systemic Conditions</label>
                <select name="systemic_condition" class="form-select" multiple size="6">
                    <% const sys = (patient?.systemic_condition || "").split(","); %>

                    <option value="No Chronic Disease" <%= sys.includes("No Chronic Disease")?"selected":"" %>>No Chronic Disease</option>
                    <option value="HTN" <%= sys.includes("HTN")?"selected":"" %>>HTN</option>
                    <option value="DM" <%= sys.includes("DM")?"selected":"" %>>DM</option>
                    <option value="HIV" <%= sys.includes("HIV")?"selected":"" %>>HIV</option>
                    <option value="Neurological" <%= sys.includes("Neurological")?"selected":"" %>>Neurological</option>
                    <option value="ALS" <%= sys.includes("ALS")?"selected":"" %>>ALS</option>
                    <option value="MS" <%= sys.includes("MS")?"selected":"" %>>MS</option>
                </select>
                <small class="text-muted">Hold Ctrl / Cmd to select multiple</small>
                </div>

                <div class="col-md-6">
                <label class="form-label">Surgeries</label>
                <select name="ocular_surgery" class="form-select" multiple size="5">
                    <% const surg = (patient?.ocular_surgery || "").split(","); %>

                    <option value="None" <%= surg.includes("None")?"selected":"" %>>None</option>
                    <option value="Cataract" <%= surg.includes("Cataract")?"selected":"" %>>Cataract</option>
                    <option value="Glaucoma" <%= surg.includes("Glaucoma")?"selected":"" %>>Glaucoma</option>
                    <option value="Brain Surgery" <%= surg.includes("Brain Surgery")?"selected":"" %>>Brain Surgery</option>
                    <option value="Others" <%= surg.includes("Others")?"selected":"" %>>Others</option>
                </select>
                </div>
            </div>
        </div>
    </div>

    <!-- VISUAL ACUITY -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-semibold">Visual Acuity</div>
      <div class="card-body">

        <div class="row text-center fw-semibold mb-2">
          <div class="col"></div>
          <div class="col">OD</div>
          <div class="col">OS</div>
        </div>

        <div class="row mb-2">
          <div class="col fw-semibold">VA</div>
          <div class="col">
            <input name="va_od" class="form-control"
                   value="<%= patient?.va_od || '' %>">
          </div>
          <div class="col">
            <input name="va_os" class="form-control"
                   value="<%= patient?.va_os || '' %>">
          </div>
        </div>

        <div class="row">
          <div class="col fw-semibold">PH</div>
          <div class="col">
            <input name="ph_od" class="form-control"
                   value="<%= patient?.ph_od || '' %>">
          </div>
          <div class="col">
            <input name="ph_os" class="form-control"
                   value="<%= patient?.ph_os || '' %>">
          </div>
        </div>

      </div>
    </div>

    <!-- OBJECTIVE REFRACTION -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-semibold">Objective Refraction</div>
      <div class="card-body">

        <div class="row text-center fw-semibold mb-2">
          <div class="col"></div>
          <div class="col">Sphere</div>
          <div class="col">Cylinder</div>
          <div class="col">Axis</div>
        </div>

        <div class="row mb-2">
          <div class="col fw-semibold">OD</div>
          <div class="col"><input name="sph_od_obj" class="form-control" value="<%= patient?.sph_od_obj || '' %>"></div>
          <div class="col"><input name="cyl_od_obj" class="form-control" value="<%= patient?.cyl_od_obj || '' %>"></div>
          <div class="col"><input name="axis_od_obj" class="form-control" value="<%= patient?.axis_od_obj || '' %>"></div>
        </div>

        <div class="row">
          <div class="col fw-semibold">OS</div>
          <div class="col"><input name="sph_os_obj" class="form-control" value="<%= patient?.sph_os_obj || '' %>"></div>
          <div class="col"><input name="cyl_os_obj" class="form-control" value="<%= patient?.cyl_os_obj || '' %>"></div>
          <div class="col"><input name="axis_os_obj" class="form-control" value="<%= patient?.axis_os_obj || '' %>"></div>
        </div>

      </div>
    </div>

    <!-- SUBJECTIVE REFRACTION -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-semibold">Subjective Refraction</div>
      <div class="card-body">

        <div class="row text-center fw-semibold mb-2">
          <div class="col"></div>
          <div class="col">Sphere</div>
          <div class="col">Cylinder</div>
          <div class="col">Axis</div>
        </div>

        <div class="row mb-2">
          <div class="col fw-semibold">OD</div>
          <div class="col"><input name="sph_od_sub" class="form-control" value="<%= patient?.sph_od_sub || '' %>"></div>
          <div class="col"><input name="cyl_od_sub" class="form-control" value="<%= patient?.cyl_od_sub || '' %>"></div>
          <div class="col"><input name="axis_od_sub" class="form-control" value="<%= patient?.axis_od_sub || '' %>"></div>
        </div>

        <div class="row">
          <div class="col fw-semibold">OS</div>
          <div class="col"><input name="sph_os_sub" class="form-control" value="<%= patient?.sph_os_sub || '' %>"></div>
          <div class="col"><input name="cyl_os_sub" class="form-control" value="<%= patient?.cyl_os_sub || '' %>"></div>
          <div class="col"><input name="axis_os_sub" class="form-control" value="<%= patient?.axis_os_sub || '' %>"></div>
        </div>
        <div class="row mt-2">
            <div class="col fw-semibold">VA (cc)</div>
                <div class="col">
                    <input name="va_od_sub" class="form-control"
                        value="<%= patient?.va_od_sub || '' %>">
                </div>
                <div class="col">
                    <input name="va_os_sub" class="form-control"
                        value="<%= patient?.va_os_sub || '' %>">
                </div>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col fw-semibold">ADD</div>
                <div class="col">
                    <input name="add_od" class="form-control"
                        value="<%= patient?.add_od || '' %>">
                </div>
                <div class="col">
                    <input name="add_os" class="form-control"
                        value="<%= patient?.add_os || '' %>">
            </div>  </div>
        </div>
    </div>


    <!-- NOTES -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-semibold">Clinical Notes</div>
      <div class="card-body">

        <div class="mb-3">
          <label class="form-label">Current Health Status</label>
          <textarea name="current_health_status" class="form-control" rows="2"><%= patient?.current_health_status || '' %></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Diagnosis</label>
          <textarea name="diagnosis" class="form-control" rows="2"><%= patient?.diagnosis || '' %></textarea>
        </div>

        <div>
          <label class="form-label">Notes</label>
          <textarea name="notes" class="form-control" rows="3"><%= patient?.notes || '' %></textarea>
        </div>

      </div>
    </div>

    <div class="d-flex justify-content-between">
      <a href="/patients" class="btn btn-outline-secondary">
        Cancel
      </a>

      <button class="btn btn-success px-4">
        <i class="fas fa-save me-1"></i>
        Save Patient
      </button>
    </div>

  </form>
</div>

<%- include("../partials/footer") %>
