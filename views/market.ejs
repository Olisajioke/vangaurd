<%- include("partials/header") %>

<main>
  <!-- HERO / INTRO -->
  <section class="py-5 text-center text-white hero-market">
    <div class="container position-relative">
      <div class="row py-lg-5">
        <div class="col-lg-6 col-md-8 mx-auto">
          <h1 class="fw-light">Mini Market</h1>
          <p class="lead fw-normal text-white-75">
            Buy and sell items within the community. Tap any item to see full details and more photos.
          </p>
          <p>
            <button class="btn btn-success my-2" data-bs-toggle="modal" data-bs-target="#createItemModal">
              + Post Item
            </button>
          </p>
        </div>
      </div>
    </div>
  </section>


  <!-- GRID -->
  <div class="album py-5 bg-body-tertiary">
    <div class="container">

      <% if (!items || items.length === 0) { %>
        <p class="text-center">No items available yet. Be the first to post üéâ</p>
      <% } %>

      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
        <% items.forEach(item => { %>
          <div class="col">
            <div class="card shadow-sm h-100">

              <!-- SINGLE THUMBNAIL ONLY -->
                <%
                  const firstImage = item.image1 || item.image2 || item.image3;
                %>

                <% if (firstImage) { %>
                  <img src="/uploads/<%= firstImage %>"
                      class="card-img-top"
                      style="height:225px; object-fit:cover;">
                <% } else { %>
                  <div class="d-flex align-items-center justify-content-center bg-light"
                      style="height:225px;">
                    <span class="text-muted">No Image</span>
                  </div>
                <% } %>


              <div class="card-body d-flex flex-column">
                <h5 class="card-title"><%= item.title %></h5>
                <p class="card-text text-truncate"><%= item.description %></p>
                <div class="mt-auto d-flex justify-content-between align-items-center">
                  <% if (item.user_id === userId || isAdmin ) { %>
                    <div class="btn-group">
                      <a href="/item/<%= item.id %>" class="btn btn-sm btn-outline-secondary">
                        View
                      </a>

                      <button class="btn btn-sm btn-outline-primary"
                              data-bs-toggle="modal"
                              data-bs-target="#editItemModal-<%= item.id %>">
                        Edit
                      </button>

                      <button class="btn btn-sm btn-outline-danger"
                              data-bs-toggle="modal"
                              data-bs-target="#deleteItemModal-<%= item.id %>">
                        Delete
                      </button>
                    </div>
                  <% } else { %>
                    <a href="/item/<%= item.id %>" class="btn btn-sm btn-outline-secondary">
                      View
                    </a>
                  <% } %>
                  <small class="text-body-secondary">ÿ±.ÿ≥ <%= item.price %></small>
                </div>
              </div>
              <div class="card-footer bg-white border-0 d-flex justify-content-between">
                <span class="text-muted small"><%= item.seller %></span>
                <% const isSaved = savedIds.includes(item.id); %>
                <form action="/toggle-save/<%= item.id %>" method="POST">
                  <button class="btn btn-link p-0 border-0" title="Save">
                    <% if (isSaved) { %>‚ù§Ô∏è<% } else { %>ü§ç<% } %>
                  </button>
                </form>
              </div>

            </div>
          </div>

          <%- include("partials/editItemModal", { item }) %>
          <%- include("partials/deleteItemModal", { item }) %>
        <% }) %>
      </div>
    </div>
  </div>
</main>

<%- include("partials/createItemModal") %>
<%- include("partials/footer") %>
